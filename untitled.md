# Second

Черновик правки [https://github.com/eucariot/SDSM/blob/master/4.-stp/02-rstp.md](https://github.com/eucariot/SDSM/blob/master/4.-stp/02-rstp.md)

## RSTP

Все, о чем мы говорили ранее в этой статье, относится к первой реализация протокола STP, которая была разработана в 1985 году Радией Перлман \(ее стихотворение использовано в качестве эпиграфа\). В 1990 году эта реализации была включена в стандарт IEEE 802.1D. Тогда время текло медленнее, и перестройка топологии STP, занимающая 30-50 секунд \(!!!\), всех устраивала. Но времена меняются, и через десять лет, в 2001 году, IEEE представляет новый стандарт **RSTP** \(он же 802.1w, он же Rapid Spanning Tree Protocol, он же Быстрый STP\).

Чтобы структурировать предыдущий материал и посмотреть различия между обычным STP \(802.1d\) и RSTP \(802.1w\), соберем таблицу с основными фактами:

<table>
  <thead>
    <tr>
      <th style="text-align:left"><b>STP (802.1d)</b>
      </th>
      <th style="text-align:left"><b>RSTP (802.1w)</b>
      </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align:left">
        <p>&#x412; &#x443;&#x436;&#x435; &#x441;&#x43B;&#x43E;&#x436;&#x438;&#x432;&#x448;&#x435;&#x439;&#x441;&#x44F;
          &#x442;&#x43E;&#x43F;&#x43E;&#x43B;&#x43E;&#x433;&#x438;&#x438; &#x442;&#x43E;&#x43B;&#x44C;&#x43A;&#x43E;
          &#x43A;&#x43E;&#x440;&#x43D;&#x435;&#x432;&#x43E;&#x439; &#x441;&#x432;&#x438;&#x447;
          &#x448;&#x43B;&#x435;&#x442; BPDU,</p>
        <p>&#x43E;&#x441;&#x442;&#x430;&#x43B;&#x44C;&#x43D;&#x44B;&#x435; &#x440;&#x435;&#x442;&#x440;&#x430;&#x43D;&#x441;&#x43B;&#x438;&#x440;&#x443;&#x44E;&#x442;</p>
      </td>
      <td style="text-align:left">&#x412;&#x441;&#x435; &#x441;&#x432;&#x438;&#x447;&#x438; &#x448;&#x43B;&#x44E;&#x442;
        BPDU &#x432; &#x441;&#x43E;&#x43E;&#x442;&#x432;&#x435;&#x442;&#x441;&#x442;&#x432;&#x438;&#x438;
        &#x441; hello-&#x442;&#x430;&#x439;&#x43C;&#x435;&#x440;&#x43E;&#x43C;
        (2 &#x441;&#x435;&#x43A;&#x443;&#x43D;&#x434;&#x44B; &#x43F;&#x43E; &#x443;&#x43C;&#x43E;&#x43B;&#x447;&#x430;&#x43D;&#x438;&#x44E;)</td>
    </tr>
    <tr>
      <td style="text-align:left"><b>&#x421;&#x43E;&#x441;&#x442;&#x43E;&#x44F;&#x43D;&#x438;&#x44F; &#x43F;&#x43E;&#x440;&#x442;&#x43E;&#x432;</b>
      </td>
      <td style="text-align:left"></td>
    </tr>
    <tr>
      <td style="text-align:left">
        <ul>
          <li>blocking (&#x431;&#x43B;&#x43E;&#x43A;&#x438;&#x440;&#x43E;&#x432;&#x43A;&#x430;)</li>
          <li>listening (&#x43F;&#x440;&#x43E;&#x441;&#x43B;&#x443;&#x448;&#x438;&#x432;&#x430;&#x43D;&#x438;&#x435;)</li>
          <li>learning (&#x43E;&#x431;&#x443;&#x447;&#x435;&#x43D;&#x438;&#x435;)</li>
          <li>forwarding (&#x43F;&#x435;&#x440;&#x435;&#x43D;&#x430;&#x43F;&#x440;&#x430;&#x432;&#x43B;&#x435;&#x43D;&#x438;&#x435;/&#x43F;&#x435;&#x440;&#x435;&#x441;&#x44B;&#x43B;&#x43A;&#x430;)</li>
          <li>disabled (&#x43E;&#x442;&#x43A;&#x43B;&#x44E;&#x447;&#x435;&#x43D;)</li>
        </ul>
      </td>
      <td style="text-align:left">
        <ul>
          <li>discarding (&#x43E;&#x442;&#x431;&#x440;&#x430;&#x441;&#x44B;&#x432;&#x430;&#x43D;&#x438;&#x435;,
            &#x437;&#x430;&#x43C;&#x435;&#x43D;&#x44F;&#x435;&#x442; disabled, blocking
            &#x438; listening)</li>
          <li>learning</li>
          <li>forwarding</li>
        </ul>
      </td>
    </tr>
    <tr>
      <td style="text-align:left"><b>&#x420;&#x43E;&#x43B;&#x438; &#x43F;&#x43E;&#x440;&#x442;&#x43E;&#x432;</b>
      </td>
      <td style="text-align:left"></td>
    </tr>
    <tr>
      <td style="text-align:left">
        <ul>
          <li>root (&#x43A;&#x43E;&#x440;&#x43D;&#x435;&#x432;&#x43E;&#x439;), &#x443;&#x447;&#x430;&#x441;&#x442;&#x432;&#x443;&#x435;&#x442;
            &#x432; &#x43F;&#x435;&#x440;&#x435;&#x441;&#x44B;&#x43B;&#x43A;&#x435;
            &#x434;&#x430;&#x43D;&#x43D;&#x44B;&#x445;, &#x432;&#x435;&#x434;&#x435;&#x442;
            &#x43A; &#x43A;&#x43E;&#x440;&#x43D;&#x435;&#x432;&#x43E;&#x43C;&#x443;
            &#x441;&#x432;&#x438;&#x447;&#x443;</li>
          <li>designated (&#x43D;&#x430;&#x437;&#x43D;&#x430;&#x447;&#x435;&#x43D;&#x43D;&#x44B;&#x439;),
            &#x442;&#x43E;&#x436;&#x435; &#x440;&#x430;&#x431;&#x43E;&#x442;&#x430;&#x435;&#x442;,
            &#x432;&#x435;&#x434;&#x435;&#x442; &#x43E;&#x442; &#x43A;&#x43E;&#x440;&#x43D;&#x435;&#x432;&#x43E;&#x433;&#x43E;
            &#x441;&#x432;&#x438;&#x447;&#x430;</li>
          <li>non-designated (&#x43D;&#x435;&#x43D;&#x430;&#x437;&#x43D;&#x430;&#x447;&#x435;&#x43D;&#x43D;&#x44B;&#x439;),
            &#x43D;&#x435; &#x443;&#x447;&#x430;&#x441;&#x442;&#x432;&#x443;&#x435;&#x442;
            &#x432; &#x43F;&#x435;&#x440;&#x435;&#x441;&#x44B;&#x43B;&#x43A;&#x435;
            &#x434;&#x430;&#x43D;&#x43D;&#x44B;&#x445;</li>
        </ul>
      </td>
      <td style="text-align:left">
        <ul>
          <li>root (&#x43A;&#x43E;&#x440;&#x43D;&#x435;&#x432;&#x43E;&#x439;), &#x443;&#x447;&#x430;&#x441;&#x442;&#x432;&#x443;&#x435;&#x442;
            &#x432; &#x43F;&#x435;&#x440;&#x435;&#x441;&#x44B;&#x43B;&#x43A;&#x435;
            &#x434;&#x430;&#x43D;&#x43D;&#x44B;&#x445;</li>
          <li>designated (&#x43D;&#x430;&#x437;&#x43D;&#x430;&#x447;&#x435;&#x43D;&#x43D;&#x44B;&#x439;),
            &#x442;&#x43E;&#x436;&#x435; &#x440;&#x430;&#x431;&#x43E;&#x442;&#x430;&#x435;&#x442;</li>
          <li>alternate (&#x434;&#x43E;&#x43F;&#x43E;&#x43B;&#x43D;&#x438;&#x442;&#x435;&#x43B;&#x44C;&#x43D;&#x44B;&#x439;),
            &#x43D;&#x435; &#x443;&#x447;&#x430;&#x441;&#x442;&#x432;&#x443;&#x435;&#x442;
            &#x432; &#x43F;&#x435;&#x440;&#x435;&#x441;&#x44B;&#x43B;&#x43A;&#x435;
            &#x434;&#x430;&#x43D;&#x43D;&#x44B;&#x445;</li>
          <li>backup (&#x440;&#x435;&#x437;&#x435;&#x440;&#x432;&#x43D;&#x44B;&#x439;),
            &#x442;&#x43E;&#x436;&#x435; &#x43D;&#x435; &#x443;&#x447;&#x430;&#x441;&#x442;&#x432;&#x443;&#x435;&#x442;</li>
        </ul>
      </td>
    </tr>
    <tr>
      <td style="text-align:left"><b>&#x41C;&#x435;&#x445;&#x430;&#x43D;&#x438;&#x437;&#x43C;&#x44B; &#x440;&#x430;&#x431;&#x43E;&#x442;&#x44B;</b>
      </td>
      <td style="text-align:left"></td>
    </tr>
    <tr>
      <td style="text-align:left">
        <p>&#x418;&#x441;&#x43F;&#x43E;&#x43B;&#x44C;&#x437;&#x443;&#x435;&#x442;
          &#x442;&#x430;&#x439;&#x43C;&#x435;&#x440;&#x44B;:</p>
        <ul>
          <li>Hello (2 &#x441;&#x435;&#x43A;&#x443;&#x43D;&#x434;&#x44B;)</li>
          <li>Max Age (20 &#x441;&#x435;&#x43A;&#x443;&#x43D;&#x434;)</li>
          <li>Forward delay timer (15 &#x441;&#x435;&#x43A;&#x443;&#x43D;&#x434;)</li>
        </ul>
      </td>
      <td style="text-align:left">&#x418;&#x441;&#x43F;&#x43E;&#x43B;&#x44C;&#x437;&#x443;&#x435;&#x442;
        &#x43F;&#x440;&#x43E;&#x446;&#x435;&#x441;&#x441; Proposal and Agreement
        (&#x43F;&#x440;&#x435;&#x434;&#x43B;&#x43E;&#x436;&#x435;&#x43D;&#x438;&#x435;
        &#x438; &#x441;&#x43E;&#x433;&#x43B;&#x430;&#x448;&#x435;&#x43D;&#x438;&#x435;)</td>
    </tr>
    <tr>
      <td style="text-align:left">
        <p>&#x421;&#x432;&#x438;&#x447;, &#x43E;&#x431;&#x43D;&#x430;&#x440;&#x443;&#x436;&#x438;&#x432;&#x448;&#x438;&#x439;
          &#x438;&#x437;&#x43C;&#x435;&#x43D;&#x435;&#x43D;&#x438;&#x435; &#x442;&#x43E;&#x43F;&#x43E;&#x43B;&#x43E;&#x433;&#x438;&#x438;,
          &#x438;&#x437;&#x432;&#x435;&#x449;&#x430;&#x435;&#x442; &#x43A;&#x43E;&#x440;&#x43D;&#x435;&#x432;&#x43E;&#x439;
          &#x441;&#x432;&#x438;&#x447;,</p>
        <p>&#x43A;&#x43E;&#x442;&#x43E;&#x440;&#x44B;&#x439;, &#x432; &#x441;&#x432;&#x43E;&#x44E;
          &#x43E;&#x447;&#x435;&#x440;&#x435;&#x434;&#x44C;, &#x442;&#x440;&#x435;&#x431;&#x443;&#x435;&#x442;
          &#x43E;&#x442; &#x432;&#x441;&#x435;&#x445; &#x43E;&#x441;&#x442;&#x430;&#x43B;&#x44C;&#x43D;&#x44B;&#x445;
          &#x43E;&#x447;&#x438;&#x441;&#x442;&#x438;&#x442;&#x44C; &#x438;&#x445;
          &#x437;&#x430;&#x43F;&#x438;&#x441;&#x438;</p>
        <p>&#x43E; &#x442;&#x435;&#x43A;&#x443;&#x449;&#x435;&#x439; &#x442;&#x43E;&#x43F;&#x43E;&#x43B;&#x43E;&#x433;&#x438;&#x438;
          &#x432; &#x442;&#x435;&#x447;&#x435;&#x43D;&#x438;&#x435; forward delay
          timer</p>
      </td>
      <td style="text-align:left">&#x41E;&#x431;&#x43D;&#x430;&#x440;&#x443;&#x436;&#x435;&#x43D;&#x438;&#x435;
        &#x438;&#x437;&#x43C;&#x435;&#x43D;&#x435;&#x43D;&#x438;&#x439; &#x432;
        &#x442;&#x43E;&#x43F;&#x43E;&#x43B;&#x43E;&#x433;&#x438;&#x438; &#x432;&#x43B;&#x435;&#x447;&#x435;&#x442;
        &#x43D;&#x435;&#x43C;&#x435;&#x434;&#x43B;&#x435;&#x43D;&#x43D;&#x443;&#x44E;
        &#x43E;&#x447;&#x438;&#x441;&#x442;&#x43A;&#x443; &#x437;&#x430;&#x43F;&#x438;&#x441;&#x435;&#x439;</td>
    </tr>
    <tr>
      <td style="text-align:left">
        <p>&#x415;&#x441;&#x43B;&#x438; &#x43D;&#x435;&#x43A;&#x43E;&#x440;&#x43D;&#x435;&#x432;&#x43E;&#x439;
          &#x441;&#x432;&#x438;&#x447; &#x43D;&#x435; &#x43F;&#x43E;&#x43B;&#x443;&#x447;&#x430;&#x435;&#x442;
          hello-&#x43F;&#x430;&#x43A;&#x435;&#x442;&#x44B; &#x43E;&#x442; &#x43A;&#x43E;&#x440;&#x43D;&#x435;&#x432;&#x43E;&#x433;&#x43E;
          &#x432; &#x442;&#x435;&#x447;&#x435;&#x43D;&#x438;&#x435; Max Age,</p>
        <p>&#x43E;&#x43D; &#x43D;&#x430;&#x447;&#x438;&#x43D;&#x430;&#x435;&#x442;
          &#x43D;&#x43E;&#x432;&#x44B;&#x435; &#x432;&#x44B;&#x431;&#x43E;&#x440;&#x44B;</p>
      </td>
      <td style="text-align:left">&#x41D;&#x430;&#x447;&#x438;&#x43D;&#x430;&#x435;&#x442; &#x434;&#x435;&#x439;&#x441;&#x442;&#x432;&#x43E;&#x432;&#x430;&#x442;&#x44C;,
        &#x435;&#x441;&#x43B;&#x438; &#x43D;&#x435; &#x43F;&#x43E;&#x43B;&#x443;&#x447;&#x430;&#x435;&#x442;
        BPDU &#x432; &#x442;&#x435;&#x447;&#x435;&#x43D;&#x438;&#x435; 3 hello-&#x438;&#x43D;&#x442;&#x435;&#x440;&#x432;&#x430;&#x43B;&#x43E;&#x432;</td>
    </tr>
    <tr>
      <td style="text-align:left">
        <p>&#x41F;&#x43E;&#x441;&#x43B;&#x435;&#x434;&#x43E;&#x432;&#x430;&#x442;&#x435;&#x43B;&#x44C;&#x43D;&#x43E;&#x435;
          &#x43F;&#x440;&#x43E;&#x445;&#x43E;&#x436;&#x434;&#x435;&#x43D;&#x438;&#x435;
          &#x43F;&#x43E;&#x440;&#x442;&#x430; &#x447;&#x435;&#x440;&#x435;&#x437;
          &#x441;&#x43E;&#x441;&#x442;&#x43E;&#x44F;&#x43D;&#x438;&#x44F;:</p>
        <ul>
          <li>blocking (20 &#x441;&#x435;&#x43A;)</li>
          <li>listening (15 &#x441;&#x435;&#x43A;)</li>
          <li>learning (15 &#x441;&#x435;&#x43A;)</li>
          <li>forwarding</li>
        </ul>
      </td>
      <td style="text-align:left">&#x411;&#x44B;&#x441;&#x442;&#x440;&#x44B;&#x439; &#x43F;&#x435;&#x440;&#x435;&#x445;&#x43E;&#x434;
        &#x43A; forwarding &#x434;&#x43B;&#x44F; p2p &#x438; Edge-&#x43F;&#x43E;&#x440;&#x442;&#x43E;&#x432;</td>
    </tr>
  </tbody>
</table>

Как мы видим, в RSTP остались такие роли портов, как корневой и назначенный, а роль заблокированного разделили на две новых роли: Alternate и Backup. Alternate — это резервный корневой порт, а backup — резервный назначенный порт. Как раз в этой концепции резервных портов и кроется одна из причин быстрого переключения в случае отказа. Это меняет поведение системы в целом: вместо реактивной \(которая начинает искать решение проблемы только после того, как она случилась\) система становится проактивной, заранее просчитывающей “пути отхода” еще до появления проблемы. Смысл простой: для того, чтобы в случае отказа основного переключится на резервный линк, RSTP не нужно заново просчитывать топологию, он просто переключится на запасной, заранее просчитанный.

Ранее, для того, чтобы убедиться, что порт может участвовать в передаче данных, требовались таймеры, т.е. свич пассивно ждал в течение означенного времени, слушая BPDU. Ключевой фичей RSTP стало введение концепции типов портов, основанных на режиме работы линка — full duplex или half duplex \(типы портов p2p или shared, соответственно\), а также понятия пограничный порт \(тип edge p2p\), для конечных устройств. Пограничные порты назначаются, как и раньше, командой spanning-tree portfast, и с ними все понятно — при включении провода сразу переходим к forwarding-состоянию и работаем. Shared-порты работают по старой схеме с прохождением через состояния BLK — LIS — LRN — FWD. А вот на p2p-портах RSTP использует процесс предложения и соглашения \(proposal and agreement\). Не вдаваясь в [подробности,](http://blog.ine.com/2009/09/07/rstp-and-fast-convergence/) его можно описать так: свич справедливо считает, что если линк работает в режиме полного дуплекса, и он не обозначен, как пограничный, значит, на нем только два устройства- он и другой свич. Вместо того, чтобы ждать входящих BPDU, он сам пытается связаться со свичом на том конце провода с помощью специальных proposal BPDU, в которых, конечно, есть информация о стоимости маршрута к корневому свичу. Второй свич сравнивает полученную информацию со своей текущей, и принимает решение, о чем извещает первый свич посредством agreement BPDU. Так как весь этот процесс теперь не привязан к таймерам, происходит он очень быстро, только подключили новый свич и он практически сразу вписался в общую топологию и приступил к работе \(можете сами оценить скорость переключения в сравнении с обычным STP на видео\). В Cisco-мире RSTP называется PVRST \(Per-Vlan Rapid Spanning Tree\).

